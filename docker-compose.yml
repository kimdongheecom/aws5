services:
  news-service:
    build: ./news-service
    ports:
      - "8003:8003"
    env_file:
      - ./news-service/.env
    environment:
      - PYTHONUNBUFFERED=1
    restart: always
    networks:
      - lif-network
  company-service:
    build: ./company-service
    ports:
      - "8011:8011"
    env_file:
      - ./company-service/.env
    environment:
      - PYTHONUNBUFFERED=1
    restart: always
    networks:
      - lif-network

  sasb-service:
    build: ./sasb-service
    ports:
      - "8004:8004"
    env_file:
      - ./sasb-service/.env
    environment:
      - PYTHONUNBUFFERED=1
    restart: always
    networks:
      - lif-network

  issuepool-service:
    build: ./issuepool-service
    ports:
      - "8005:8005"
    env_file:
      - ./issuepool-service/.env
    environment:
      - PYTHONUNBUFFERED=1
    restart: always
    networks:
      - lif-network

  report-service:
    build: ./report-service
    ports:
      - "8006:8006"
    env_file:
      - ./report-service/.env
    environment:
      - PYTHONUNBUFFERED=1
    restart: always
    networks:
      - lif-network

  stock-service:
    build: ./stock-service
    ports:
      - "8007:8007"
    env_file:
      - ./stock-service/.env
    environment:
      - PYTHONUNBUFFERED=1
    restart: always
    networks:
      - lif-network

  thesis-service:
    build: ./thesis-service
    ports:
      - "8008:8008"
    env_file:
      - ./thesis-service/.env
    environment:
      - PYTHONUNBUFFERED=1
    restart: always
    networks:
      - lif-network

  gri-service:
    build: ./gri-service
    ports:
      - "8010:8010"
    env_file:
      - ./gri-service/.env
    environment:
      - PYTHONUNBUFFERED=1
      - CUDA_VISIBLE_DEVICES=0
    restart: always
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    networks:
      - lif-network
  
  # =========================================================
  #               수정된 Gateway 서비스 부분
  # =========================================================
  gateway:
    build: ./gateway
    ports:
      - "8080:8080"
    env_file:
      - ./gateway/.env
    # ✅ [핵심 수정] 볼륨 마운트 설정 추가
    # 로컬의 ./gateway 폴더를 컨테이너의 /app 폴더와 동기화(연결)합니다.
    # 이제 로컬에서 코드를 수정하면 컨테이너에 즉시 반영됩니다.
    volumes:
      - ./gateway:/app
    environment:
      - PYTHONUNBUFFERED=1
    dns:
      - 8.8.8.8
      - 8.8.4.4
    restart: always
    depends_on:
      - news-service
      - sasb-service
      - issuepool-service
      - report-service
      - stock-service
      - thesis-service
      - gri-service
      - company-service
    networks:
      - lif-network
  # =========================================================
  #                        수정 끝
  # =========================================================

networks:
  lif-network:
    driver: bridge
    driver_opts:
      com.docker.network.enable_ipv6: "false"
    ipam:
      config:
        - subnet: 172.20.0.0/16